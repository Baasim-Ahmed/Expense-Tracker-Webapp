{% extends "tracker/base.html" %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-4">
  <h2 class="text-center">Expense Tracker Dashboard</h2>

  <!-- Summary Cards -->
  <div class="row text-center my-4">
    <div class="col-md-4">
      <div class="card border-success">
        <div class="card-body">
          <h5 class="card-title">Balance</h5>
          <p class="card-text fw-bold text-success">{{ balance }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-primary">
        <div class="card-body">
          <h5 class="card-title">Total Income</h5>
          <p class="card-text text-primary">{{ income }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-danger">
        <div class="card-body">
          <h5 class="card-title">Total Expenses</h5>
          <p class="card-text text-danger">{{ expenses }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Form -->
  <form method="GET" class="row g-2 mb-3">
    <div class="col-md-4">
      <select name="month" class="form-select">
        <option value="">All Months</option>
        {% for val, name in months %}
          <option value="{{ val }}" {% if val == selected_month %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <select name="category" class="form-select">
        <option value="">All Categories</option>
        {% for cat in categories %}
          <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <button type="submit" class="btn btn-dark w-100">Apply Filters</button>
    </div>
  </form>

  <!-- Chart -->
  <div class="my-4 text-center">
    <canvas id="expenseChart" width="400" height="200"></canvas>
  </div>

  <!-- Add Button -->
  <div class="text-end mb-3">
    <a href="{% url 'add_transaction' %}" class="btn btn-primary">+ Add New Transaction</a>
  </div>

  <!-- Transactions Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Title</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Category</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for txn in transactions %}
        <tr>
          <td>{{ txn.title }}</td>
          <td class="{% if txn.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">{{ txn.transaction_type|title }}</td>
          <td>{{ txn.amount }}</td>
          <td>{{ txn.category }}</td>
          <td>{{ txn.timestamp|date:"Y-m-d" }}</td>
          <td>
            <a href="{% url 'edit_transaction' txn.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
            <a href="{% url 'delete_transaction' txn.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center">No transactions found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Chart Script -->
<script>
  const ctx = document.getElementById('expenseChart').getContext('2d');
  const expenseChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Income', 'Expenses'],
      datasets: [{
        label: 'Income vs Expenses',
        data: [
          parseFloat("{{ income|default:0|floatformat:'2' }}"),
          parseFloat("{{ expenses|default:0|floatformat:'2' }}")
        ],
        backgroundColor: ['#198754', '#dc3545'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        title: {
          display: true,
          text: 'Income vs Expense Summary'
        }
      }
    }
  });
</script>
{% endblock %}
